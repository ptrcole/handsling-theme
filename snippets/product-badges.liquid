{%- comment -%}
  ----------------------------------------------------------------------------------------------------------------------
  PRODUCT BADGES COMPONENT
  ----------------------------------------------------------------------------------------------------------------------

  This component is used in product listings and product pages to render the badges of a given product.

  ********************************************
  Supported variables
  ********************************************

  * product: the product to render the badges for.
  * variant: the specific variant to show the badge from.
  * types: the types of badge to output. Can be "custom", "sold_out", "discount", "shipping", or "cart_discount".
  * context: can be "product" or "card".
  * class: an extra class added on the container.
{%- endcomment -%}

{%- assign badge_types = types | default: 'custom, sold_out, discount, shipping, cart_discount' | split: ',' -%}
{%- assign variant = variant | default: product.selected_or_first_available_variant -%}

<!-- Debugging: Output the detected market (optional - remove after testing) -->
<p style="display: none;">Detected Market: {{ localization.market.name }}</p>

<!-- Check Free Shipping Eligibility by Market -->
{%- assign selected_market = localization.market.name | strip | downcase -%}
{%- assign qualifies_for_free_shipping = false -%}

{%- if selected_market == 'united kingdom'
  or selected_market == 'european union'
  or selected_market == 'non-eu europe'
-%}
  {%- assign qualifies_for_free_shipping = true -%}
{%- endif -%}

<!-- Define Qualifying Collections -->
{%- assign qualifying_collections = 'road bikes,road frames,gravel bikes,cyclocross bikes,cyclocross & gravel frames,track bikes,track frames,time-trial frames,time trial bikes,triathlon bikes,customisers'
  | split: ','
-%}
{%- assign has_qualifying_collection = false -%}

<!-- Loop through product collections to check qualification -->
{%- for collection in product.collections -%}
  {%- assign collection_title = collection.title | strip | downcase -%}
  {%- if qualifying_collections contains collection_title -%}
    {%- assign has_qualifying_collection = true -%}
  {%- endif -%}
{%- endfor -%}

<!-- Exclude products if the title contains specific colors -->
{%- assign excluded_colors = 'Ocean Green,Candy Red,Neon Green,Purple Rain,Obsidian Black,Gunmetal,Silver Bullet,Ice White,Flame Orange,Green,Cobalt Blue' | split: ',' -%}

{%- for color in excluded_colors -%}
  {%- if product.title contains color -%}
    {%- assign has_qualifying_collection = false -%}
  {%- endif -%}
{%- endfor -%}

{%- capture badges -%}
  {%- for badge_type in badge_types -%}
    {%- assign stripped_badge_type = badge_type | strip -%}

    {%- case stripped_badge_type -%}
      {%- when 'custom' -%}
        {%- assign custom_badges = product.metafields.custom.badges.value | sort -%}
        {%- for custom_badge in custom_badges -%}
          <span class="badge badge--primary">{{ custom_badge }}</span>
        {%- endfor -%}

      {%- when 'sold_out' -%}
        {%- if settings.show_sold_out_badge and variant.available == false -%}
          <sold-out-badge class="badge badge--sold-out">
            {{ 'product.general.sold_out_badge' | t }}
          </sold-out-badge>
        {%- endif -%}

      {%- when 'discount' -%}
        {%- if settings.show_discount -%}
          {%- assign show_on_sale_badge = false -%}

          {%- if context == 'product' and variant.compare_at_price > variant.price -%}
            {%- assign show_on_sale_badge = true -%}
          {%- elsif context == 'card' and product.compare_at_price > product.price -%}
            {%- assign show_on_sale_badge = true -%}
          {%- endif -%}

          {%- if show_on_sale_badge -%}
            {%- assign savings = '' -%}
            {%- if settings.discount_mode == 'percentage' -%}
              {%- assign savings = variant.compare_at_price | minus: variant.price | times: 100.0 | divided_by: variant.compare_at_price | round | append: '%' -%}
            {%- else -%}
              {%- capture savings -%}{{ variant.compare_at_price | minus: variant.price | money }}{%- endcapture -%}
            {%- endif -%}

            <on-sale-badge class="badge badge--on-sale">
              {{ 'product.general.discount_badge_html' | t: savings: savings }}
            </on-sale-badge>
          {%- endif -%}
        {%- endif -%}

      {%- when 'shipping' -%}
        {%- if qualifies_for_free_shipping and has_qualifying_collection -%}
          <span class="badge badge--free-shipping" style="background-color: #00c853; color: white; font-weight: bold;">
            Free Shipping
          </span>
        {%- endif -%}

    

    {%- endcase -%}
  {%- endfor -%}
{%- endcapture -%}

{%- if badges != blank -%}
  <div class="{{ class }}">
    {{- badges -}}
  </div>
{%- endif -%}
